<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Haunted Demo — Button Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    button { font-size: 1rem; padding: 0.6rem 1rem; margin-right: 1rem; }
    #log { margin-top: 1rem; white-space: pre-wrap; }
    .ok { color: #0a7a0a; }
    .err { color: #a00; }
  </style>
</head>
<body>
  <h1>Haunted Demo — Button Test</h1>

  <!-- Step 1: Establish the IFTTT Connect session once -->
  <button onclick="location.href='/connect'">Allow & Play (Connect)</button>

  <!-- Step 2: Trigger your Alexa routine via Voice Monkey through IFTTT Connect -->
  <button id="btnBlackout">Test Blackout</button>

  <div id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    const log = (msg, cls = '') => {
      const line = document.createElement('div');
      if (cls) line.className = cls;
      line.textContent = msg;
      logEl.appendChild(line);
    };

    async function trigger(effect) {
      log(`Calling /api/trigger with { effect: "${effect}" } ...`);
      try {
        const r = await fetch('/api/trigger', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',              // IMPORTANT: send session cookie
          body: JSON.stringify({ effect })     // IMPORTANT: use "effect", not "event"
        });
        const data = await r.json().catch(() => ({}));

        if (r.ok && data && data.ok) {
          log(`OK via: ${data.via || 'unknown'}`, 'ok');
        } else {
          log(`Error ${r.status}: ${JSON.stringify(data)}`, 'err');
        }
      } catch (e) {
        log(`Fetch error: ${e.message}`, 'err');
      }
    }

    document.getElementById('btnBlackout').addEventListener('click', () => trigger('blackout'));

    // Optional: auto-trigger after returning from /connect?autoplay=1
    (function maybeAutoplay() {
      const p = new URLSearchParams(location.search);
      if (p.get('autoplay') === '1') {
        log('Returned from Connect. Auto-triggering blackout...');
        trigger('blackout');
      } else {
        log('Tip: Click "Allow & Play (Connect)" first to authorize, then "Test Blackout".');
      }
    })();
  </script>
</body>
</html>

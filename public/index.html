<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Haunted Demo — Video Experience</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, sans-serif;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        min-height: 100vh; background: #000; color: #fff;
        padding: 20px;
      }
      button {
        font-size: 1.2rem;
        padding: 1rem 1.4rem;
        margin: 10px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        background: #c00; color: #fff;
      }
      button:hover { background: #e33; }
      #log { 
        margin-top: 1.5rem; 
        font-family: monospace; 
        white-space: pre-wrap;
        background: #222;
        padding: 10px;
        border-radius: 5px;
        max-width: 500px;
      }
      video {
        width: 100%;
        max-width: 800px;
        margin: 20px 0;
        border: 2px solid #333;
        border-radius: 8px;
      }
      .controls {
        display: flex;
        gap: 10px;
        margin: 10px 0;
      }
      .cue-points {
        margin: 15px 0;
        color: #aaa;
        font-size: 0.9rem;
        text-align: center;
      }

      .light-controls {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #333;
        border-radius: 8px;
        background: #111;
        text-align: center;
      }

      .light-controls h3 {
        margin: 0 0 10px 0;
        color: #fff;
      }

      #light-status {
        font-family: monospace;
        font-size: 0.9rem;
        padding: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Haunted House Experience</h1>
    
    <!-- Video Element -->
    <video id="film" controls>
      <source src="video/timer.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>

    <!-- Video Controls -->
    <div class="controls">
      <button id="unmute">Unmute</button>
      <button id="restart">Restart</button>
    </div>

    <!-- Cue Points Info -->
    <div class="cue-points">
      <h3>Spooky Effects at:</h3>
      <p>5s: Blackout Effect ⚡</p>
      <p>12s: Blackout Effect ⚡</p>
    </div>

    <!-- Light Control Section -->
    <div class="light-controls">
      <h3>Smart Light Control</h3>
      <button id="btnSetupLights">Setup Lights</button>
      <button id="btnTestLights">Test Lights</button>
      <div id="light-status" style="margin: 10px 0; color: #888;">
        Lights not configured
      </div>
    </div>

    <!-- Updated Test Button -->
    <button id="btnBlackoutDirect">Test All Systems</button>

    <!-- Connection & Test Buttons -->
    <button id="btnConnect">Connect Smart Home</button>
    <button id="btnBlackout">Test Blackout Effect</button>

    <!-- Status Log -->
    <div id="log"></div>

    <script>
      // Define the setupLights function first
      let lightsConfigured = false;
      
      async function setupLights() {
        try {
          const response = await fetch('/api/lights/setup', {
            method: 'POST',
            credentials: 'include'
          });
          const data = await response.json();
          
          if (data.success) {
            lightsConfigured = true;
            const lightStatusElement = document.getElementById('light-status');
            if (lightStatusElement) {
              lightStatusElement.textContent = 'LIGHTS CONNECTED';
              lightStatusElement.style.color = '#4CAF50';
            }
            console.log('Lights setup successful:', data);
          } else {
            console.error('Lights setup failed:', data.error);
            const lightStatusElement = document.getElementById('light-status');
            if (lightStatusElement) {
              lightStatusElement.textContent = 'LIGHTS SETUP FAILED';
              lightStatusElement.style.color = '#FF0000';
            }
          }
        } catch (error) {
          console.error('Error setting up lights:', error);
          const lightStatusElement = document.getElementById('light-status');
          if (lightStatusElement) {
            lightStatusElement.textContent = 'LIGHTS CONNECTION ERROR';
            lightStatusElement.style.color = '#FF0000';
          }
        }
      }
      
      function testLights() {
        fireEffect('blackout', {origin: 'manual_test'});
      }
      
      // Add event listeners when the DOM is fully loaded
      document.addEventListener('DOMContentLoaded', function() {
        // Setup lights button
        const btnSetupLights = document.getElementById('btnSetupLights');
        if (btnSetupLights) {
          btnSetupLights.addEventListener('click', setupLights);
        }
        
        // Test lights button
        const btnTestLights = document.getElementById('btnTestLights');
        if (btnTestLights) {
          btnTestLights.addEventListener('click', testLights);
        }
        
        // Test all systems button
        const btnBlackoutDirect = document.getElementById('btnBlackoutDirect');
        if (btnBlackoutDirect) {
          btnBlackoutDirect.addEventListener('click', function() {
            fireEffect('blackout', {origin: 'manual_test'});
          });
        }
        
        // Connect button
        const btnConnect = document.getElementById('btnConnect');
        if (btnConnect) {
          btnConnect.addEventListener('click', function() {
            window.open('https://ifttt.com/connections/rbgN3WXF-haunted-demo', '_blank');
          });
        }
        
        // Blackout test button
        const btnBlackout = document.getElementById('btnBlackout');
        if (btnBlackout) {
          btnBlackout.addEventListener('click', async function() {
            const logEl = document.getElementById('log');
            const log = (msg) => { logEl.textContent += (logEl.textContent ? '\n' : '') + msg; };
            
            log('Testing blackout effect…');
            try {
              const r = await fetch('/api/trigger', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ effect: 'blackout' })
              });
              const data = await r.json();
              log('Response: ' + JSON.stringify(data));
            } catch (e) {
              log('Error: ' + e.message);
            }
          });
        }
        
        // Video event listeners for debugging
        const film = document.getElementById('film');
        if (film) {
          film.addEventListener('timeupdate', () => {
            document.title = `Haunted Demo - ${Math.floor(film.currentTime)}s`;
          });

          film.addEventListener('play', () => {
            const logEl = document.getElementById('log');
            const log = (msg) => { logEl.textContent += (logEl.textContent ? '\n' : '') + msg; };
            log('Video started playing at ' + film.currentTime + 's');
          });
        }
        
        // Set up other UI elements
        const unmuteBtn = document.getElementById('unmute');
        const restartBtn = document.getElementById('restart');
        
        if (unmuteBtn && film) {
          unmuteBtn.addEventListener('click', () => { 
            film.muted = false; 
            film.volume = 1.0; 
          });
        }
        
        if (restartBtn && film) {
          restartBtn.addEventListener('click', () => {
            // Reset cues for replay
            if (window.cues) {
              for (const c of window.cues) c.fired = false;
            }
            film.currentTime = 0;
            film.play().catch(()=>{});
          });
        }
      });
    </script>
    
    <!-- Include your app.js AFTER defining the setupLights function -->
    <script src="/app.js"></script>
  </body>
</html>